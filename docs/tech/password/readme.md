# パスワードの保存について

このシステムのパスワード暗号化は、非常に強固で多層的な仕組みになっています。

初めての方にもわかりやすく、金庫に例えてステップバイステップで説明します。

---

## パスワードの暗号化（金庫にしまう方法）

ユーザーがパスワードを新規登録したり変更したりする時（`userApply.js`など）、システムは`phash.js`の`hashPassword`という関数を呼び出します。これは、以下の3重のロックをかけるような処理です。

### ステップ1： 最初のハッシュ化（SHA-512 + ソルト + シュガー）
まず、あなたのパスワードをそのままでは使いません。

1.  **ソルト (Salt) を加える:**
    * システムは「ソルト」と呼ばれるランダムな文字列を自動で生成します。これは、料理で使う塩のように、パスワードに振りかける「目印」です。
    * このソルトはユーザーごとに異なり、**パスワードを推測されにくくする**ために非常に重要です。
2.  **シュガー (Sugar) を加える:**
    * 次に、システム全体で共有している秘密の文字列「シュガー」も加えます。これは、システムの開発者だけが知っている秘密のスパイスのようなものです。
3.  **ハッシュ化 (SHA-512):**
    * 「あなたのパスワード」+「ランダムなソルト」+「秘密のシュガー」を全部混ぜ合わせたものを、SHA-512というハッシュ関数にかけます。
    * ハッシュ化とは、元のデータを一見ランダムな固定長の文字列（指紋のようなもの）に変換することです。この「指紋」からは、元のパスワードを絶対に復元できません。

**例えるなら:**
あなたのパスワード（`password123`）を、「ソルト（`Abc`）」と「シュガー（`Xyz`）」と一緒にミキサー（SHA-512）にかけて、ドロドロのジュース（ハッシュ）にするイメージです。このジュースから元の材料を当てることはできません。

---

### ステップ2： 2回目のハッシュ化（Bcrypt）
次に、ステップ1で作った「指紋（ハッシュ）」を、さらに別の方法で加工します。

1.  **Bcryptにかける:**
    * ステップ1のハッシュを、今度はBcryptという別のハッシュ関数にかけます。
    * Bcryptの最大の特徴は、**わざと処理に時間がかかるように設計されている**ことです。
    * これにより、攻撃者が1秒間に何十億回もパスワードを試すような「総当たり攻撃（ブルートフォースアタック）」を非常に困難にします。

**例えるなら:**
ステップ1のジュースを、今度は「ものすごく時間のかかるオーブン（Bcrypt）」で焼き固めて、カチカチのクッキーにするイメージです。

---

### ステップ3： 暗号化（AES-256 + ペッパー）
最後に、このBcryptで作ったハッシュ（クッキー）を、さらに暗号化して隠します。

1.  **ペッパー (Pepper) と別のソルトを使う:**
    * システムは「ペッパー」という、シュガーとは別の秘密の文字列（秘密鍵）と、「AES用の新しいソルト」を使って、暗号化のための「鍵」を作ります。
2.  **暗号化 (AES-256):**
    * この「鍵」と、さらに「IV（初期化ベクトル）」という別のランダムな文字列を使って、ステップ2のBcryptハッシュをAES-256という強力な暗号方式で暗号化します。

**例えるなら:**
ステップ2のクッキー（Bcryptハッシュ）を、「秘密の鍵（ペッパー由来）」でしか開けられない金庫（AES暗号）に入れるようなものです。

---

### 最終的な保存
データベース（`users`テーブルの`hashed_password`カラム）に保存されるのは、あなたのパスワードそのものではなく、以下の情報を全部くっつけた**1つの長い文字列**です：

`[バージョン情報]:[ステップ1のソルト]:[ステップ3のIV]:[ステップ3のAES用ソルト]:[ステップ3で暗号化されたデータ]`

あなたの生のパスワードは、どこにも保存されません。

---

## パスワードの照合（金庫を開ける方法）

あなたがログインする時（`login.js`）、システムは`verifyPassword`という関数を使って、入力されたパスワードが正しいか確認します。

1.  データベースから、あの長い「ハッシュ文字列」を取り出します。
2.  その文字列を「:」で分解し、「ステップ1のソルト」「IV」「AES用ソルト」「暗号化データ」をそれぞれ取り出します。
3.  **ステップ3の逆（復号）:**
    * システムの秘密の「ペッパー」と取り出した「AES用ソルト」で「鍵」を復元します。
    * その「鍵」と「IV」を使って、「暗号化データ」を復号（解読）します。
    * → これにより、保存されていた「Bcryptハッシュ（ステップ2のクッキー）」が取り出せます。
4.  **ステップ1の実行:**
    * あなたが**今入力したパスワード**に、取り出しておいた「ステップ1のソルト」と、システムの秘密の「シュガー」を混ぜて、SHA-512ハッシュを**新しく作ります**。
5.  **ステップ2の比較:**
    * ステップ3で復号した「保存されていたBcryptハッシュ」と、ステップ4で「新しく作ったSHA-512ハッシュ」を、Bcryptの比較機能で比べます。

もし2つがピッタリ一致すれば、あなたが入力したパスワードは正しいと判断され、ログインが成功します。

---

## なぜこんなに複雑なの？

* **ソルト (Salt):** 同じパスワード（例: `123456`）を使っている人が複数いても、ソルトが違うのでデータベース上では全く異なるハッシュになり、安全性が高まります。
* **ストレッチング (Bcrypt):** わざと処理を遅くすることで、総当たり攻撃をほぼ不可能にします。
* **ペッパー / シュガー (Pepper / Sugar):** これらはサーバーのコードや設定ファイルに保存されています。万が一データベース（金庫）が丸ごと盗まれても、この「秘密の鍵」がなければ解読が非常に困難になり、パスワードを守ることができます。

## 優位点

この方式の優位点は、**「万が一、データベースが盗まれても、パスワードを解読される可能性を限りなくゼロに近づける」**という点にあります。

この「多層防御」の仕組みが、他のシンプルな方式（例えばパスワードをSHA-256でハッシュ化するだけ）と比べてどれだけ優れているか、3つのポイントで説明します。

---

### 1. 攻撃に「時間」をかけさせる（Bcryptによる遅延）

**優位点:** 総当たり攻撃（ブルートフォースアタック）を現実的に不可能にします。

* このシステムの「ステップ2（Bcrypt）」は、**わざと計算に時間がかかるように設計されています**。
* 攻撃者が高性能なコンピュータを使っても、1つのパスワードを試すのに例えば0.1秒かかるとします。これでも、1秒間に10回しか試せません。
* もしこの仕組みがなければ、攻撃者は1秒間に何十億回もパスワードを試すことができてしまいます。Bcryptを採用していることで、攻撃の効率を何億分の一にも下げているのです。
* この「時間稼ぎ」は、セキュリティにおいて非常に強力な防御策となります。

---

### 2. 「金庫（DB）が盗まれても中身を守れる」（ペッパーによる暗号化）

**優位点:** データベースが流出しても、パスワードハッシュ自体が暗号化されているため安全です。

* 多くのシステムでは、データベースが盗まれると「ハッシュ化されたパスワード」が盗まれます。攻撃者はそのハッシュを時間をかけて解読しようとします（上記1.への挑戦）。
* しかしこのシステムでは、「ステップ3（AES暗号化）」のおかげで、データベースに保存されているのは**「暗号化されたハッシュ」**です。
* これを解読（復号）するには、**データベースには保存されていない「ペッパー（秘密鍵）」**が必要です。
* **例えるなら:**
    * 普通のシステム：「金庫（DB）が盗まれると、中から『解読が必要な暗号文（ハッシュ）』が出てくる」
    * このシステム：「金庫（DB）が盗まれると、中から『**鍵のかかった小さな箱（AES暗号）**』が出てくる。その箱の鍵（ペッパー）は、金庫とは別の場所（サーバー）に隠してある」

この二重構造により、仮にデータベース（金庫）を丸ごと奪われても、攻撃者は「鍵のかかった箱」を前に何もできない、という圧倒的な優位性を持っています。

---

### 3. 「よくあるパスワード」でも安全（ソルトによる固有化）

**優位点:** 「レインボーテーブル攻撃」と呼ばれる典型的な攻撃手法を無効化します。

* もしAさんとBさんが同じパスワード（例: `password123`）を使っていた場合、ソルトがないとデータベース上でも同じハッシュ値が保存されてしまいます。
* このシステムの「ステップ1（ソルト）」では、**ユーザーごとに異なるランダムな文字列（ソルト）**を加えてハッシュ化します。
* そのため、AさんとBさんが同じパスワードでも、データベース上では全く異なるハッシュ値になります。
* これにより、攻撃者が「よく使われるパスワード（`password123`や`123456`など）のハッシュ値をあらかじめ計算してリスト化しておく」という攻撃（レインボーテーブル攻撃）が一切通用しなくなります。

---

### （おまけ）ログイン試行時の「タイミング攻撃」にも対策

* ログイン時（`login.js`）、もし入力されたユーザーIDが存在しなかった場合でも、システムは「IDが間違っている」とすぐに応答しません。
* わざとダミーのデータを使って、**正しいIDが入力された時とほぼ同じ時間**をかけてから「失敗」と応答します。
* これにより、攻撃者が「応答が早かったから、このIDは存在しないな」と推測する（タイミング攻撃）のを防いでいます。

**まとめ:**
この方式は、**「遅延（Bcrypt）」**、**「機密性の分離（ペッパー）」**、**「固有化（ソルト）」**という、現代のパスワード保護におけるベストプラクティスをすべて組み合わせた、非常に強固で先進的な仕組みと言えます。


