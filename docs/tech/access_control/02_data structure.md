このアクセス制御システムのデータベース構造について、特に重要な点や理解しておくべきポイントを説明しますね。

仕様や使い方を理解した上で、以下のテーブル（データベースの表）の関係性を掴むと、システム全体の動きがより深く理解できます。

---

## **1\. 中心となるテーブル 🌟**

アクセス制御の心臓部は、主に以下のテーブルとその繋がりで構成されています。

* **contexts テーブル:**  
  * これが「ルールブック」の実体です。  
  * id と parent\_id を持ち、親子関係（階層）を作ることができます。parent\_id が \-1 なら、それが一番上の階層（ルート）です。  
  * **迷いそうな点:** 「コンテキスト」は抽象的な概念なので、最初はイメージしにくいかもしれません。「権限ルールをまとめておくための箱」で、「箱」自体に親子関係がある、と考えるとわかりやすいです。  
* **resources テーブル:**  
  * 保護対象の「モノ」を管理します。  
  * target（種類、例: TREE=1）と target\_id（その種類のID、例: 10）で、システム内の具体的なモノ（例: ツリーID 10）を一意に識別します。  
  * **ポイント:** このテーブル自体には権限情報は**含まれません**。  
* **access\_rules テーブル:**  
  * **最も重要**なテーブルです。具体的な「誰が」「何を」「どこで」許可/拒否されるかを定義します。  
  * 主な列：  
    * context\_id: どの「ルールブック」に属するか。  
    * action\_id: どの「操作」（例: tree.list）に対するルールか。  
    * unit: ルールの対象（ユーザー=1, グループ=2, Tier=3, 全員=4）。  
    * unit\_id: 対象の具体的なID（ユーザーID、グループID、Tier ID）。  
    * is\_allow: true（許可）か false（拒否）か。  
    * orderno: ルールの優先順位（小さいほど優先度が高い）。  
  * **ポイント:** 権限チェック（isAllowed）は、主にこのテーブルを検索してルールを探します。

---

## **2\. 関係性をつなぐ「マッピング」テーブル 🔗**

上記の中心的なテーブル同士や、ユーザー・グループ・Tierなどを結びつける「中間テーブル（マッピングテーブル）」が非常に重要です。

* **map\_resource\_context テーブル:**  
  * 「リソース（モノ）」と「コンテキスト（ルールブック）」を結びつけます。resource\_id と context\_id のペアを持ちます。  
  * **迷いそうな点:** なぜリソースとコンテキストを分けるのか？ → これにより、複数のリソースで同じルールブックを共有したり、逆に1つのリソースに複数のルールブック（異なる権限体系）を適用したりする柔軟性が生まれます。  
* **map\_usergroup テーブル:**  
  * 「ユーザー」と「グループ」を結びつけます。user\_id と group\_id のペアを持ちます。  
  * これにより、ユーザーがどのグループに所属しているかがわかります。  
* **map\_usertier / map\_grouptier テーブル:**  
  * **特に重要:** ユーザーやグループに「Tier（役割）」を割り当てます**が、context\_id も含みます**。  
  * つまり、「ユーザーAは、コンテキストXにおいてはリーダーTier」のように、**場所（コンテキスト）ごとに役割が変わる**ことを実現するためのテーブルです。  
  * **確実に理解すべき点:** この context\_id 列があるおかげで、「Context依存Tier」というこのシステムの高度な機能が成り立っています。Tierはグローバルなものではない、という点がポイントです。

---

## **3\. その他の補助的なテーブル 🛠️**

* **users, groups, tiers, actions テーブル:**  
  * それぞれユーザー情報、グループ情報、Tier（役割）の名前、アクション（操作）の名前などを管理する基本的なマスターテーブルです。access\_rules などからは、これらのテーブルのIDが参照されます。  
* **user\_self\_rules, group\_self\_rules, tier\_self\_rules テーブル:**  
  * isAllowedSelf で使われる、「自分自身」や「自分が所属するグループ/Tier」に対する操作（ABAC）のルールを定義します。  
* **user\_rules, group\_rules, tier\_rules テーブル:**  
  * 新しいコンテキストを作成する際にコピーされる「テンプレートルール」です。access\_rules と似ていますが、こちらはあくまで雛形です。

---

**まとめ:**

* 中心は contexts（ルールブック）, resources（モノ）, access\_rules（ルール）。  
* map\_\*\*\* テーブルがこれらを柔軟に結びつけている。  
* 特に map\_usertier, map\_grouptier の context\_id が「Context依存Tier」を実現する鍵。  
* ルール (access\_rules) は context\_id, action\_id, unit, unit\_id, is\_allow, orderno で構成される。

これらのテーブル構造と関係性を理解することで、「なぜ isAllowed があのような複雑な処理（継承をたどり、コンテキストごとにTierを計算し、ルールを探す）をしているのか」が見えてくるはずです。
