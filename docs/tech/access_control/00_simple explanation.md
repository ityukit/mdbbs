このアクセス制御（誰が何をしていいかを決める仕組み）の仕様について、初めて見る方にもわかりやすく説明しますね。

このシステムは、「**何（リソース）**」に対する操作権限を、「**誰（ユーザー）**」に与えるかを決めるものです。かなり高機能ですが、基本的な考え方はシンプルです。

---

## **1\. 基本的な考え方：「モノ」と「ルールブック」 🧱📚**

まず、システムには大きく分けて2つの要素があります。

* **リソース (Resource):** 権限で保護したい「モノ」のことです。例えば、「投稿ツリーA」とか「ユーザーBのプロフィール」とか、「グループC」などがこれにあたります。  
* **コンテキスト (Context):** そのリソースに適用される「ルールブック」のようなものです。このルールブックの中に、「誰が」「何をしていいか」というルール（access\_rules）がたくさん書かれています。

**ポイント:** 「モノ（リソース）」と「ルールブック（コンテキスト）」は**別々に管理**されます。一つのモノに複数のルールブックが関連付けられることもあります。

---

## **2\. ルールの継承：「親のルールは子のルール」 👨‍👩‍👧‍👦**

このシステムの大きな特徴は「**継承**」です。

* ルールブック（コンテキスト）には親子関係があります。例えば、「部署フォルダ」のルールブックの親は「会社全体」のルールブック、といった感じです。  
* あるモノ（例: 「企画書ファイル」）の権限をチェックするとき、まずそのモノに直接関連付けられたルールブックを見ます。  
* そこにルールがなければ、親のルールブック、さらにその親のルールブック…と、**先祖をたどってルールを探します**。まるで、「自分の家にルールがなければ、親の家のルールに従う」という感じです。

---

## **3\. 「誰が」アクセスできるか？：ユーザー・グループ・Tier（役割） 👤👥👑**

ルールブックに書かれているルールは、主に以下の単位で指定されます。

1. **特定のユーザー:** 「ユーザーID: 5 の人だけ許可」のように指定します。  
2. **特定のグループ:** 「開発部グループに所属する人は許可」のように指定します。ユーザーは複数のグループに所属できます。  
3. **特定のTier（役割）:** 「管理者Tier（ロール）を持つ人は許可」のように指定します。ユーザーやグループには、役割（Tier）を割り当てることができます。  
4. **全員:** 「ログインしていれば誰でもOK」というルールも指定できます。

特に重要な点（Context依存Tier）:  
このシステムのユニークな点は、Tier（役割）が場所によって変わることです。例えば、ユーザーAさんは「プロジェクトXの場所ではリーダーTier」だけど、「会社全体では一般社員Tier」といった設定が可能です。権限チェックの際は、今いる場所（コンテキスト）で有効なTierを正しく使って判断します。

---

## **4\. ルールの優先順位：「ダメ」が一番強い！ 🚫👍**

ルールが複数見つかったり、矛盾したりする場合のルールです。

1. **拒否優先 (Deny Overrides):** 継承をたどる中で、\*\*1つでも「禁止（is\_allow \= false）」のルールが見つかれば、他のどんな許可ルールがあっても即座に「アクセス禁止」\*\*と決定されます。これが最も安全なルールです。  
2. **許可 (Permit):** 拒否ルールが見つからず、「許可（is\_allow \= true）」のルールが見つかれば、「アクセス許可」となります。  
3. **優先度 (orderno):** 同じ場所（コンテキスト）に複数のルールがある場合は、orderno という番号が小さいルールが優先されます。  
4. **自分自身ルール (ABAC):** 継承ルールで許可も拒否もされなかった場合、「自分自身の投稿を編集する」や「自分が所属するグループの情報を編集する」といった、**モノと本人の関係性**に基づく特別なルール（isAllowedSelf） でチェックされます。  
5. **デフォルト拒否 (Default Deny):** 上記のどのルールにも当てはまらなかった場合、最終的には\*\*「アクセス禁止」\*\*となります。明示的に許可されていない操作はできない、という安全な考え方です。

---

## **5\. キャッシュによる高速化 ⚡**

この権限チェックは非常に複雑ですが、一度計算した結果（ユーザーAがツリーBにアクセスできるか等）や、途中で必要になる情報（ユーザーAの所属グループリスト等）は、**キャッシュ**（高速な一時記憶装置）に保存されます。

これにより、2回目以降のアクセスではデータベースへの問い合わせを大幅に減らし、**高速に応答できる**ようになっています。権限などが変更された場合は、関連するキャッシュが削除され、再計算される仕組みです。

---

まとめ:  
このシステムは、場所（コンテキスト）ごとにルールブックを用意し、親子関係でルールを引き継ぎます。役割（Tier）も場所によって変わるという特徴があります。「禁止」ルールが最優先され、どのルールにも当てはまらなければ基本的に禁止されます。複雑な計算結果はキャッシュして高速化しています。
