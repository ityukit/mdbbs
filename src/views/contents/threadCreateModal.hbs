<!-- thread create -->
<div class="modal fade modal-xl" id="threadCreate" data-bs-keyboard="false" tabindex="-1" aria-labelledby="threadCreateLabel" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen2">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="threadCreateLabel">{{ __ 'page.contents.thread.modal.create.title' }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form class="row g-3" id="threadCreateForm" onsubmit="return threadCreateModal_createThread()">
          <h3 id="threadCreateTarget"></h3>
          <p id="threadCreateDescription"></p>
          <hr>
          <div class="row">
            <div class="col-12 mb-3">
              <label for="threadCreateTitle" class="form-label">{{ __ 'page.contents.thread.modal.create.threadTitle' }}*</label>
              <input type="text" class="form-control" id="threadCreateTitle" required>
            </div>
            <div class="col-12 mb-3">
              <label for="threadCreateContentTitle" class="form-label">{{ __ 'page.contents.thread.modal.create.contentTitle' }}*</label>
              <input type="text" class="form-control" id="threadCreateContentTitle" required>
            </div>
            <ul class="nav nav-tabs" id="threadCreateViewTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="threadCreateViewTab-source" data-bs-toggle="tab" data-bs-target="#threadCreateViewTab-source-pane" type="button" role="tab" aria-controls="threadCreateViewTab-source-pane" aria-selected="true">{{ __ 'page.contents.thread.modal.create.source' }}</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="threadCreateViewTab-preview" data-bs-toggle="tab" data-bs-target="#threadCreateViewTab-preview-pane" type="button" role="tab" aria-controls="threadCreateViewTab-preview-pane" aria-selected="false" onclick="threadCreateModal_previewContent()">{{ __ 'page.contents.thread.modal.create.preview' }}</button>
              </li>
            </ul>
            <div class="tab-content" id="threadCreateViewTabContent">
              <div class="tab-pane fade show active" id="threadCreateViewTab-source-pane" role="tabpanel" aria-labelledby="threadCreateViewTab-source" tabindex="0">
                <label for="threadCreateContent" class="form-label">{{ __ 'page.contents.thread.modal.create.content' }}*</label>
                <textarea class="form-control" id="threadCreateContent" rows="6" required></textarea>
              </div>
              <div class="tab-pane fade" id="threadCreateViewTab-preview-pane" role="tabpanel" aria-labelledby="threadCreateViewTab-preview" tabindex="0">
                <label for="threadCreateContentPreview" class="form-label">{{ __ 'page.contents.thread.modal.create.contentPreview' }}</label>
                <div id="threadCreateContentPreview" class="border p-2 contents-preview"></div>
              </div>
            </div>
            <div class="col-12 mb-3" id="threadCreateViewTabTag">
              <label for="threadCreateTag" class="form-label">{{ __ 'page.contents.thread.modal.create.threadTag' }}</label>
              <select class="form-control" multiple="multiple" id="threadCreateTag">
              </select>
            </div>
          </div>
          <hr>
          <p>{{ __ 'page.contents.thread.modal.create.contentDetail' }}</p>
          <div>
            <div class="col">
              <label for="threadCreateFirstSortKey" class="form-label">{{ __ 'page.contents.thread.modal.create.contentFirstSortKey' }}</label>
              <input type="number" class="form-control" id="threadCreateFirstSortKey" step="1" max="999999999" min="-999999999">
            </div>
            <div class="col">
              <label for="threadCreateSecondSortKey" class="form-label">{{ __ 'page.contents.thread.modal.create.contentSecondSortKey' }}</label>
              <input type="text" class="form-control" id="threadCreateSecondSortKey">
            </div>
          </div>
          <div class="text-end">{{ __ 'page.contents.thread.modal.create.threadEssDesc' }}</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ __ 'page.contents.thread.modal.create.modalClose' }}</button>
            <button type="submit" class="btn btn-primary" id="threadCreateSubmit">
              <span id="threadDoCreateText">{{ __ 'page.contents.thread.modal.create.doCreate' }}</span>
              <span id="threadDoCreateSpinner" class="d-none">
                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                {{ __ 'page.contents.thread.modal.create.creating' }}
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  function threadCreateModal_createThread() {
    const title = document.getElementById('threadCreateTitle').value;
    const contentTitle = document.getElementById('threadCreateContentTitle').value;
    const content = document.getElementById('threadCreateContent').value;
    $("#threadCreateSubmit").prop("disabled", true);
    $("#threadDoCreateText").addClass("d-none");
    $("#threadDoCreateSpinner").removeClass("d-none");
    let tags = $('#threadCreateTag').val() || [];
    tags = tags.map(tag => {
      if (tag.startsWith('new:')) {
        return { tag_id: null, display_name: tag.slice(4) };
      } else {
        return { tag_id: tag, display_name: null };
      }
    });
    const firstSortKey = parseInt(document.getElementById('threadCreateFirstSortKey').value) || 0;
    const secondSortKey = document.getElementById('threadCreateSecondSortKey').value || '';
    $.ajax({
      type: 'POST',
      url: '{{ baseUrl }}/api/contents/threadCreate',
      data: {
        nodeId: threadCreateTargetId,
        title: title,
        contentTitle: contentTitle,
        content: content,
        parser: 'default',
        tags: tags,
        firstSortKey: firstSortKey,
        secondSortKey: secondSortKey,
        _csrf: '{{_csrf}}'
      },
      dataType: 'json',
      success: function(data) {
        if (data && !data.error) {
          // 作成成功
          // TODO: スレッド作成成功時の処理
          // modalを閉じる
          $('#threadCreate').modal('hide');
          // reload
          location.reload();          
        }else{
          // TODO: スレッド作成失敗時の処理
          alert('{{ __ "page.contents.thread.modal.create.createError" }}');
        }
      },
      error: function() {
        // TODO: エラーハンドリング
        alert('{{ __ "page.contents.thread.modal.create.createError" }}');
      },
      complete: function() {
        $("#threadCreateSubmit").prop("disabled", false);
        $("#threadDoCreateText").removeClass("d-none");
        $("#threadDoCreateSpinner").addClass("d-none");
      }
    });
    return false; // フォーム送信をキャンセル
  }
  function threadCreateModal_previewContent() {
    const content = document.getElementById('threadCreateContent').value;
    if (content.trim().length === 0) {
      $('#threadCreateContentPreview').text('{{ __ "page.contents.thread.modal.create.previewEmpty" }}');
      return;
    }
    $('#threadCreateContentPreview').text('{{ __ "page.contents.thread.modal.create.previewLoading" }}');
    $.ajax({
      type: 'POST',
      url: '{{ baseUrl }}/api/contents/parse',
      data: {
        content: content,
        parser: 'default',
        _csrf: '{{_csrf}}'
      },
      dataType: 'json',
      success: function(data) {
        if (data && data.contentsparsed) {
          $('#threadCreateContentPreview').html(data.contentsparsed);
          // highlight.js
          document.querySelectorAll('#threadCreateContentPreview pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          $('#threadCreateContentPreview').text('{{ __ "page.contents.thread.modal.create.previewError" }}');
        }
      },
      error: function() {
        $('#threadCreateContentPreview').text('{{ __ "page.contents.thread.modal.create.previewError" }}');
      }
    });
  }
  let threadCreateTargetId = '';
  let threadCreateTargetName = '';
  let threadCreateTargetTree = '';
  addEventListener("load", (event) => {
    $('#threadCreate').on('shown.bs.modal', function (event) {
      if (!threadCreateTargetId) {
        threadCreateTargetName = '{{ __ "page.contents.thread.modal.create.threadCreateTargetNameRoot" }}';
        threadCreateTargetTree = '{{ __ "page.contents.thread.modal.create.threadCreateTargetDescRoot" }}';
      }
      $('#threadCreateTarget').text(format_string('{{ __ "page.contents.thread.modal.create.threadCreateTargetName" }}', [threadCreateTargetName]));
      $('#threadCreateDescription').text(format_string('{{ __ "page.contents.thread.modal.create.threadCreateTargetDesc" }}', [threadCreateTargetTree]));
      $('#threadCreateTitle').val('');
      $('#threadCreateContentTitle').val('');
      $('#threadCreateContent').val('');
      $('#threadCreateContentPreview').text('{{ __ "page.contents.thread.modal.create.previewEmpty" }}');
      $('#threadCreateTag').val(null).trigger('change');
      $("#threadCreateSubmit").prop("disabled", false);
      $("#threadDoCreateText").removeClass("d-none");
      $("#threadDoCreateSpinner").addClass("d-none");
      $('#threadCreateFirstSortKey').val('');
      $('#threadCreateSecondSortKey').val('');
    });
  });
  // select2
  $(document).ready(function() {
    $('#threadCreateTag').select2({
      dropdownParent: $('#threadCreate'),
      width: '100%',
      allowClear: true,
      tags: true,
      tokenSeparators: [',', ' ' ,';','>', '\n','\t',
                        '、','　','；','＞',
                        '，　','。','．','・','/','\\'],
      ajax: {
        url: (param)=>{return "{{ baseUrl }}/api/contents/tagcloud"},
        data: function (params) {
          var query = {
            tagWord: params.term,
            maxCount: 50,
            treeId: threadCreateTargetId,
            useGroup: 1,
          }
          return query;
        },
        delay: 250 ,
        dataType: 'json',
        processResults: function (data) {
          return {
            results: data.map(function(group) {
              return {
                "text": group.text,
                "children": group.children.map(function(tag) {
                  return { id: tag.tag_id, text: tag.display_name };
                })
              };
            }),
            pagination: {
              more: false
            }
          };
        },
        cache: false
      },
      matcher: (params, data) => {
        // If there are no search terms, return all of the data
        if ($.trim(params.term) === '') {
          return data;
        }
        // Do not display the item if there is no 'text' property
        if (typeof data.text === 'undefined') {
          return null;
        }
        // `params.term` should be the term that is used for searching
        // `data.text` is the text that is displayed for the data object
        if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
          var modifiedData = $.extend({}, data, true);
          // You can modify/add properties to the object as you like
          // modifiedData.text += ' (matched)';
          return modifiedData;
        }
        // Return `null` if the term should not be displayed
        return null;
      },
      createTag: function (params) {
        var term = $.trim(params.term);
        if (term === '') {
          return null;
        }
        return {
          id: 'new:' + term,
          text: term,
          newTag: true // add additional parameters
        };
      },
    });
    let threadCreate__tagDropdownTimer = null;
    window.addEventListener('keydown', e => {
      if (threadCreate__tagDropdownTimer) {
        clearTimeout(threadCreate__tagDropdownTimer);
        threadCreate__tagDropdownTimer = null;
      }
      if (e.target.closest('#threadCreateViewTabTag')) {
        // 目的地近くでのキー入力
        if (e.isComposing || e.key === 'Process' || e.keyCode === 229) {
          // IME入力中
          $('#threadCreate .select2-dropdown').hide();
          threadCreate__tagDropdownTimer = setTimeout(() => {
            $('#threadCreate .select2-dropdown').show();
            threadCreate__tagDropdownTimer = null;
          }, 1500);
        } else {
          // IME入力中でない
          $('#threadCreate .select2-dropdown').show();
        }
      }
    }, true);
  });
</script>