<!-- contents sub create -->
<div class="modal fade modal-xl" id="contentsSubCreate" data-bs-keyboard="false" tabindex="-1" aria-labelledby="contentsSubCreateLabel" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen2">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="contentsSubCreateLabel">{{ __ 'page.contents.thread.modal.subcreate.title' }}</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="contentsSubCreateLoading" class="d-flex align-items-center">
          <div class="spinner-border" role="status"></div>
          &nbsp; &nbsp;
          {{ __ 'page.contents.thread.modal.subcreate.dataLoading' }}
        </div>
        <form class="row g-3 d-none" id="contentsSubCreateForm" onsubmit="return contentsSubCreateModal_createContents()">
          <h3 id="contentsSubCreateTarget"></h3>
          <p id="contentsSubCreateDescription"></p>
          <hr>
          <div class="row">
            <div class="col-12 mb-3">
              <label for="contentsSubCreateContentTitle" class="form-label">{{ __ 'page.contents.thread.modal.subcreate.contentTitle' }}*</label>
              <input type="text" class="form-control" id="contentsSubCreateContentTitle" required>
            </div>
            <ul class="nav nav-tabs" id="contentsSubCreateViewTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="contentsSubCreateViewTab-source" data-bs-toggle="tab" data-bs-target="#contentsSubCreateViewTab-source-pane" type="button" role="tab" aria-controls="contentsSubCreateViewTab-source-pane" aria-selected="true">{{ __ 'page.contents.thread.modal.subcreate.source' }}</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="contentsSubCreateViewTab-preview" data-bs-toggle="tab" data-bs-target="#contentsSubCreateViewTab-preview-pane" type="button" role="tab" aria-controls="contentsSubCreateViewTab-preview-pane" aria-selected="false" onclick="contentsSubCreateModal_previewContent()">{{ __ 'page.contents.thread.modal.subcreate.preview' }}</button>
              </li>
            </ul>
            <div class="tab-content" id="contentsSubCreateViewTabContent">
              <div class="tab-pane fade show active" id="contentsSubCreateViewTab-source-pane" role="tabpanel" aria-labelledby="contentsSubCreateViewTab-source" tabindex="0">
                <label for="contentsSubCreateContent" class="form-label">{{ __ 'page.contents.thread.modal.subcreate.contentContent' }}*</label>
                <textarea class="form-control" id="contentsSubCreateContent" rows="6" required></textarea>
              </div>
              <div class="tab-pane fade" id="contentsSubCreateViewTab-preview-pane" role="tabpanel" aria-labelledby="contentsSubCreateViewTab-preview" tabindex="0">
                <label for="contentsSubCreateContentPreview" class="form-label">{{ __ 'page.contents.thread.modal.subcreate.contentPreview' }}</label>
                <div id="contentsSubCreateContentPreview" class="border p-2 contents-preview"></div>
              </div>
            </div>
          </div>
          <div class="text-end">{{ __ 'page.contents.thread.modal.subcreate.contentEssDesc' }}</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ __ 'page.contents.thread.modal.subcreate.modalClose' }}</button>
            <button type="submit" class="btn btn-primary" id="contentsSubCreateSubmit">
              <span id="contentsDoSubCreateText">{{ __ 'page.contents.thread.modal.subcreate.doSubCreate' }}</span>
              <span id="contentsDoSubCreateSpinner" class="d-none">
                <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
                {{ __ 'page.contents.thread.modal.subcreate.creating' }}
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  function contentsSubCreateModal_createContents() {
    if (contentsSubCreateTargetId === '') {
      alert('{{ __ "page.contents.thread.modal.subcreate.noTargetError" }}');
      return false; // フォーム送信をキャンセル
    }
    const contentTitle = document.getElementById('contentsSubCreateContentTitle').value;
    const content = document.getElementById('contentsSubCreateContent').value;
    $("#contentsSubCreateSubmit").prop("disabled", true);
    $("#contentsDoSubCreateText").addClass("d-none");
    $("#contentsDoSubCreateSpinner").removeClass("d-none");
    $.ajax({
      type: 'POST',
      url: '{{ baseUrl }}/api/contents/contentsCreate',
      data: {
        targetContentsId: contentsSubCreateTargetId,
        contentTitle: contentTitle,
        content: content,
        parser: 'default',
        mode: 'tree',
        _csrf: '{{_csrf}}'
      },
      dataType: 'json',
      success: function(data) {
        if (data && !data.error) {
          // 更新成功
          // TODO: コンテンツ更新成功時の処理
          // modalを閉じる
          $('#contentsSubCreate').modal('hide');
          // reload
          location.reload();          
        }else{
          // TODO: コンテンツ更新失敗時の処理
          alert('{{ __ "page.contents.thread.modal.subcreate.createError" }}');
        }
      },
      error: function() {
        // TODO: エラーハンドリング
        alert('{{ __ "page.contents.thread.modal.subcreate.createError" }}');
      },
      complete: function() {
        $("#contentsSubCreateSubmit").prop("disabled", false);
        $("#contentsDoSubCreateText").removeClass("d-none");
        $("#contentsDoSubCreateSpinner").addClass("d-none");
      }
    });
    return false; // フォーム送信をキャンセル
  }
  function contentsSubCreateModal_previewContent() {
    const content = document.getElementById('contentsSubCreateContent').value;
    if (content.trim().length === 0) {
      $('#contentsSubCreateContentPreview').text('{{ __ "page.contents.thread.modal.subcreate.previewEmpty" }}');
      return;
    }
    $('#contentsSubCreateContentPreview').text('{{ __ "page.contents.thread.modal.subcreate.previewLoading" }}');
    $.ajax({
      type: 'POST',
      url: '{{ baseUrl }}/api/contents/parse',
      data: {
        content: content,
        parser: 'default',
        _csrf: '{{_csrf}}'
      },
      dataType: 'json',
      success: function(data) {
        if (data && data.contentsparsed) {
          $('#contentsSubCreateContentPreview').html(data.contentsparsed);
          // highlight.js
          document.querySelectorAll('#contentsSubCreateContentPreview pre code').forEach((block) => {
            hljs.highlightElement(block);
          });
        } else {
          $('#contentsSubCreateContentPreview').text('{{ __ "page.contents.thread.modal.subcreate.previewError" }}');
        }
      },
      error: function() {
        $('#contentsSubCreateContentPreview').text('{{ __ "page.contents.thread.modal.subcreate.previewError" }}');
      }
    });
  }
  let contentsSubCreateTargetId = '';
  addEventListener("load", (event) => {
    $('#contentsSubCreate').on('shown.bs.modal', function (event) {
      if (contentsSubCreateTargetId === '') {
        alert('{{ __ "page.contents.thread.modal.subcreate.noTargetError" }}');
        $('#contentsSubCreate').modal('hide');
        return;
      }
      $('#contentsSubCreateContentTitle').val('');
      $('#contentsSubCreateContent').val('');
      $('#contentsSubCreateContentPreview').text('{{ __ "page.contents.thread.modal.subcreate.previewEmpty" }}');
      $("#contentsSubCreateSubmit").prop("disabled", false);
      $("#contentsDoSubCreateText").removeClass("d-none");
      $("#contentsDoSubCreateSpinner").addClass("d-none");
      $('#contentSubCreateLoading').removeClass('d-none');
      $('#contentsSubCreateForm').addClass('d-none');
      $.ajax({
        type: 'GET',
        url: '{{ baseUrl }}/api/contents/info',
        data: {
          contentsId: contentsSubCreateTargetId,
        },
        dataType: 'json',
        success: function(data) {
          if (data && !data.error) {
            $('#contentsSubCreateLoading').addClass('d-none');
            $('#contentsSubCreateForm').removeClass('d-none');
            $('#contentsSubCreateTarget').text(format_string('{{ __ "page.contents.thread.modal.subcreate.title" }}', data.title));
            $('#contentsSubCreateDescription').text(format_string('{{ __ "page.contents.thread.modal.subcreate.description" }}', data.title));
          } else {
            alert('{{ __ "page.contents.thread.modal.subcreate.loadError" }}');
            $('#contentsSubCreate').modal('hide');
          }
        },
        error: function() {
          alert('{{ __ "page.contents.thread.modal.subcreate.loadError" }}');
          $('#contentsSubCreate').modal('hide');
        }
      });
    });
  });
  function contentSubCreateModal_setTarget(id) {
    contentsSubCreateTargetId = id;
    $('#contentsSubCreate').modal('show');
  }
</script>